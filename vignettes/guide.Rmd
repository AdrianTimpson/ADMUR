---
title: "Guide to using PopCPLmodel"
author: "Adrian Timpson"
date: "06/07/2020"
output: rmarkdown::html_vignette
description: >
  A comprehensive guide to modelling population dynamics using PopCPLmodel.
  
vignette: >
  %\VignetteIndexEntry{Guide to using PopCPLmodel}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

This vignette provides a guide to using the R package PopCPLmodel, to accompany and support the publication 'Directly modelling population dynamics in the South American Arid Diagonal using 14C dates', Philosophical Transactions B, 2020, A. Timpson et al. It assumes the user has some basic familiarity with programming in R. 

## Installation

The PopCPLmodel package can be installed directly from GitHub, after installing and loading the 'devtools' package on the CRAN:

```{r, eval = FALSE}
install.packages('devtools')
library(devtools)
install_github('UCL/PopCPLmodel')
```

The PopCPLModel package can then be locally loaded:

```{r, message = FALSE}
library(PopCPLmodel)
```

## 14C datasets

A summary of the available help files and data sets included in the package can be browsed, which include a terrestrial anthropogenic 14C dataset from the South American Arid Diagonal:

```{r, eval = FALSE}
help(PopCPLmodel)
help(arid)
```

Datasets must be structured as a data.frame that include columns 'age' and 'sd', which represent the uncalibated 14C age and its error, respectively.


```{r, eval = TRUE}
arid[1:5,1:8]
```


## Calibrated 14C date probability distributions

The algorithm used by PopCPLmodel to calculate model likelihoods of a 14C dataset has a component that calibrates the 14C dates. Therefore this package also provides functions that are intrinsically useful for ordinary date calibration or for generating a Summed Probability Distribution (SPD).

Generating a single calibrated date distribution or SPD requires either a two step process to give the user full control of the date range and temporal resolution, or a simpler one step process using a wrapper function that automatically estimates a sensible date range and resolution from the dataset, performs the two step process internally, and outputs a plot of the SPD.

### With the wrapper

1. Use the function [summedCalibratorWrapper()](../html/summedCalibratorWrapper.html) 

```{r, eval = TRUE, fig.height = 4, fig.width=7, fig.align = "center", dev='svg', warning=FALSE}
data <- data.frame( age = c(6562,7144),  sd = c(44,51)  )
x <- summedCalibratorWrapper(data)
```

Notice the function automatically assumed the data provided were all 14C dates. However, if you have other kinds of date such as thermoluminescence you can specify 'nonC14'. You can also specify a particular calibration curve:

```{r, eval = TRUE, fig.height = 4, fig.width=7, fig.align = "center", dev='svg', warning=FALSE}
data <- data.frame( age = c(6562,7144),  sd = c(44,51), datingType = c('C14','nonC14') )
x <- summedCalibratorWrapper(data, shcal13)
```

### Without the wrapper

Generating the SPD without the wrapper gives you more control, and requires a two step process:

1. Convert a calibration curve to a CalArray using the function [makeCalArray()](../html/makeCalArray.html)
1. Calibrate the 14C dates through the CalArray using the [summedCalibrator()](../html/summedCalibrator.html) function.

```{r, eval = TRUE, fig.height = 4, fig.width=7, fig.align = "center", dev='svg', warning=FALSE}
data <- data.frame(age = c(9144), sd=c(151) )
CalArray <- makeCalArray( intcal13, calrange = c(8000,13000) )
cal <- summedCalibrator(data, CalArray)
plotCal(cal)
```
The CalArray is essentially a two-dimensional probability array of the calibration curve, and can be viewed using using the [plotCalArray()](../html/plotCalArray.html) function. Although the calibration curve has a maximum temporal resolution of 5 cal yrs, a finer resolution CalArray can be generated using the parameter inc which interpolates the calibration curve. However, this can be time costly if plotting the entire 50,000 year range of the calibration curve. 

```{r, eval = TRUE, fig.height = 5, fig.width=5, fig.align = "center", dev='svg'}
x <- makeCalArray(shcal13, c(5500,6000), inc=1 )
plotCalArray(x)
```


## Calibration comparison with other software

It is worth noting that the algorithm used by this package to calibrate 14C dates gives equivalent results to those from [OxCal](https://c14.arch.ox.ac.uk/oxcal.html) generated using  [OxcAAR](https://cran.r-project.org/web/packages/oxcAAR/index.html) but these differ slightly to the results generated by [Bchron](https://cran.r-project.org/web/packages/Bchron/index.html).

![Comparison of calibration software for the 14C date: 150 +/- 25 calibrated through intcal13. This PopCPLmodel package (grey) and Oxcal (blue) give equivalent results, whilst Bchron differs in several locations on the curve.](software compare.svg)

## Phased data: adjusting for ascertainment bias

A naive approach to generating an SPD as a proxy for population dynamics would be to sum all dates in the dataset, but a more sensible approach is to sum the SPDs of each phase. The need to bin dates into phases is an important step in modelling population dynamics to adjust for the data ascertainment bias of some archaeological finds having more dates by virtue of a larger research interest/budget. 

Therefore [phaseCalibrator()](../html/phaseCalibrator.html) generates an SPD for each phase in a dataset, and includes a binning algorithm which provides a simple and useful solution to handling large datasets that have not been phased.

